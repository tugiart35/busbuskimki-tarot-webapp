================================================================================
VERÄ°TABANI MÄ°GRATÄ°ON VE BACKUP RAPORU
================================================================================
Tarih: 2025-10-13
Proje: TaraTarot
VeritabanÄ±: Supabase PostgreSQL

================================================================================
1. MÄ°GRATÄ°ON KLASÃ–RÃœ DURUMU
================================================================================

âœ… Migration KlasÃ¶rÃ¼: /migrations (Mevcut)
ğŸ“ Toplam Migration DosyasÄ±: 18 dosya

Migration DosyalarÄ±:
-------------------
001_create_tarot_cards_tables.sql          (4.4 KB)
002_insert_sample_tarot_cards.sql          (10.5 KB)
003_insert_seo_data.sql                    (12.6 KB)
20241201_01_types.sql                      (1.6 KB)
20241201_02_tables.sql                     (7.0 KB)
20241201_03_constraints.sql                (4.3 KB)
20241201_04_indexes.sql                    (6.3 KB)
20241201_05_rls.sql                        (8.4 KB)
20241201_06_functions.sql                  (11.8 KB)
20250911_01-types.sql                      (513 B)
20250911_02-tables.sql                     (5.9 KB)
20250911_03-constraints.sql                (147 B)
20250911_04-indexes.sql                    (2.2 KB)
20250911_05-rls.sql                        (1.5 KB)
20250911_06-seed.sql                       (16 B)
20250930_01-add-marriage-enum.sql          (855 B)
20250930_02-system-performance.sql         (2.2 KB)
refactor-moves.plan.json                   (15.5 KB)

Migration Kronolojisi:
---------------------
AÅŸama 1: Temel Tarot TablolarÄ± (001-003)
AÅŸama 2: KullanÄ±cÄ± ve Ä°ÅŸlem TablolarÄ± (20241201_01-06)
AÅŸama 3: Sistem GÃ¼ncellemeleri (20250911_01-06)
AÅŸama 4: Ä°yileÅŸtirmeler (20250930_01-02)

================================================================================
2. ANA SCHEMA DURUMU
================================================================================

âœ… Ana Schema DosyasÄ±: schema.sql (Mevcut ve GÃ¼ncel)

VeritabanÄ± YapÄ±sÄ±:
------------------
â€¢ Extensions: pgcrypto, pg_trgm
â€¢ Custom Types: reading_type_enum, reading_status_enum
â€¢ Ana Tablolar (11):
  - profiles (KullanÄ±cÄ± profilleri)
  - admins (Admin yetkileri)
  - readings (Tarot okumalarÄ±)
  - transactions (Kredi iÅŸlemleri)
  - packages (Kredi paketleri)
  - spreads (Tarot aÃ§Ä±lÄ±mlarÄ±)
  - audit_logs (GÃ¼venlik loglarÄ±)
  - pricing_tiers (FiyatlandÄ±rma)
  - user_subscriptions (Abonelikler)
  - user_payment_methods (Ã–deme yÃ¶ntemleri)
  - user_transactions (Ã–deme iÅŸlemleri)

â€¢ Ek Tablolar:
  - system_performance (Sistem performans metrikleri)
  - webhook_events (Webhook kayÄ±tlarÄ±)

â€¢ Views:
  - tarot_readings (Geriye dÃ¶nÃ¼k uyumluluk)
  - spreads_public (Halka aÃ§Ä±k aÃ§Ä±lÄ±mlar)

â€¢ Fonksiyonlar:
  - fn_create_reading_with_debit() (Atomik okuma + kredi)
  - fn_award_bonus_credits() (Bonus kredi verme)
  - log_system_performance() (Performans loglama)
  - set_updated_at() (Otomatik gÃ¼ncelleme)

================================================================================
3. RLS (ROW LEVEL SECURÄ°TY) POLÄ°TÄ°KALARI
================================================================================

âœ… RLS Politika DosyasÄ±: policies.sql (Mevcut ve DÃ¼zeltilmiÅŸ)

Ã–nemli Notlar:
--------------
â€¢ Sonsuz dÃ¶ngÃ¼ sorunu Ã§Ã¶zÃ¼ldÃ¼ (2025-01-11)
â€¢ Admin politikalarÄ± admin_users tablosunu kullanÄ±yor
â€¢ TÃ¼m tablolarda RLS etkin
â€¢ KullanÄ±cÄ±lar sadece kendi verilerini gÃ¶rebilir
â€¢ Adminler tÃ¼m verilere eriÅŸebilir

RLS Etkin Tablolar:
------------------
âœ… profiles
âœ… admin_users  
âœ… readings
âœ… transactions
âœ… packages
âœ… spreads
âœ… audit_logs
âœ… pricing_tiers
âœ… user_subscriptions
âœ… user_payment_methods
âœ… user_transactions
âœ… system_performance

================================================================================
4. UYGULAMA DURUMU KONTROLÃœ
================================================================================

Migration Uygulama Durumunu Kontrol Etmek Ä°Ã§in:
-----------------------------------------------

A) Supabase Dashboard Ãœzerinden:
   1. https://supabase.com/dashboard adresine girin
   2. Projenizi seÃ§in
   3. SQL Editor'e gidin
   4. AÅŸaÄŸÄ±daki sorguyu Ã§alÄ±ÅŸtÄ±rÄ±n:

   SELECT tablename 
   FROM pg_tables 
   WHERE schemaname = 'public' 
   ORDER BY tablename;

   Beklenen Tablolar:
   - admins
   - admin_users
   - audit_logs
   - packages
   - pricing_tiers
   - profiles
   - readings
   - spreads
   - system_performance
   - transactions
   - user_payment_methods
   - user_subscriptions
   - user_transactions
   - webhook_events

B) Yerel Kontrol (Supabase CLI ile):
   ```bash
   # Supabase CLI yÃ¼klÃ¼ deÄŸilse:
   npm install -g supabase
   
   # Proje baÄŸlantÄ±sÄ±nÄ± kontrol et:
   supabase db remote inspect
   
   # Migration history:
   supabase migration list
   ```

================================================================================
5. BACKUP TALÄ°MATLARI
================================================================================

ğŸš¨ UYARI: Production'a geÃ§meden Ã–NCE mutlaka yedek alÄ±n!

YÃ¶ntem 1: Supabase Dashboard (Ã–nerilen)
----------------------------------------
1. Supabase Dashboard > Project Settings > Database
2. "Database backups" sekmesine gidin
3. "Create backup" butonuna tÄ±klayÄ±n
4. Backup'Ä±n tamamlanmasÄ±nÄ± bekleyin
5. Backup listesini kaydedin

Otomatik Backup AyarlarÄ±:
â€¢ Supabase Pro planÄ±nda gÃ¼nlÃ¼k otomatik backup
â€¢ 7 gÃ¼n boyunca saklanÄ±r
â€¢ Point-in-time recovery mevcut

YÃ¶ntem 2: Supabase CLI ile Dump
--------------------------------
```bash
# TÃ¼m database dump'Ä±:
supabase db dump -f backup-$(date +%Y%m%d-%H%M%S).sql

# Sadece schema:
supabase db dump --schema-only -f schema-backup.sql

# Sadece data:
supabase db dump --data-only -f data-backup.sql
```

YÃ¶ntem 3: pg_dump ile (Direkt PostgreSQL)
------------------------------------------
âš ï¸ NOT: BaÄŸlantÄ± bilgileri .env dosyasÄ±nda olmalÄ±

BaÄŸlantÄ± bilgileri iÃ§in:
1. Supabase Dashboard > Project Settings > Database
2. "Connection string" kÄ±smÄ±ndan direct connection string'i alÄ±n

Komut:
```bash
pg_dump "postgresql://postgres:[PASSWORD]@db.[PROJECT-REF].supabase.co:5432/postgres" \
  -f backup-$(date +%Y%m%d).sql \
  --clean \
  --if-exists \
  --no-owner \
  --no-privileges
```

YÃ¶ntem 4: Manuel SQL Export
----------------------------
Sadece uygulama verileri iÃ§in:

```sql
-- profiles yedek
COPY (SELECT * FROM profiles) TO '/tmp/profiles_backup.csv' CSV HEADER;

-- readings yedek
COPY (SELECT * FROM readings) TO '/tmp/readings_backup.csv' CSV HEADER;

-- transactions yedek
COPY (SELECT * FROM transactions) TO '/tmp/transactions_backup.csv' CSV HEADER;

-- packages yedek
COPY (SELECT * FROM packages) TO '/tmp/packages_backup.csv' CSV HEADER;
```

================================================================================
6. RESTORE TALÄ°MATLARI
================================================================================

YÃ¶ntem 1: Supabase Dashboard'dan Restore
-----------------------------------------
1. Project Settings > Database > Backups
2. Restore edilecek backup'Ä± seÃ§in
3. "Restore" butonuna tÄ±klayÄ±n
4. OnaylayÄ±n ve bekleyin

YÃ¶ntem 2: SQL Dump'tan Restore
-------------------------------
```bash
# Supabase CLI ile:
supabase db reset --db-url "postgresql://..."

# veya psql ile:
psql "postgresql://postgres:[PASSWORD]@db.[PROJECT-REF].supabase.co:5432/postgres" \
  -f backup-file.sql
```

================================================================================
7. PRODUCTION HAZIRLIK KONTROL LÄ°STESÄ°
================================================================================

VeritabanÄ± HazÄ±rlÄ±ÄŸÄ±:
--------------------
â˜ 1. TÃ¼m migration'lar uygulandÄ± mÄ±?
     Kontrol: SELECT tablename FROM pg_tables WHERE schemaname = 'public';

â˜ 2. RLS politikalarÄ± aktif mi?
     Kontrol: SELECT tablename, rowsecurity FROM pg_tables WHERE schemaname = 'public';

â˜ 3. Test verisi temizlendi mi?
     UyarÄ±: delete-all-users.sql dosyasÄ± mevcut, dikkatli kullanÄ±n!

â˜ 4. Backup alÄ±ndÄ± mÄ±?
     Son backup tarihi: _____________

â˜ 5. Admin kullanÄ±cÄ± oluÅŸturuldu mu?
     INSERT INTO admin_users (user_id, role) VALUES ('[UUID]', 'admin');

â˜ 6. Indexes oluÅŸturuldu mu?
     Kontrol: \di (psql) veya Dashboard > Database > Indexes

â˜ 7. Performance tablosu seed edildi mi?
     SELECT COUNT(*) FROM system_performance;

â˜ 8. Package'lar oluÅŸturuldu mu?
     SELECT COUNT(*) FROM packages WHERE active = true;

â˜ 9. Spread yapÄ±landÄ±rmalarÄ± eklendi mi?
     SELECT COUNT(*) FROM spreads WHERE active = true;

â˜ 10. Webhook events tablosu test edildi mi?
      SELECT COUNT(*) FROM webhook_events;

Environment Variables:
----------------------
â˜ NEXT_PUBLIC_SUPABASE_URL (Production URL)
â˜ NEXT_PUBLIC_SUPABASE_ANON_KEY (Production Anon Key)
â˜ SUPABASE_SERVICE_ROLE_KEY (Production Service Role - GÄ°ZLÄ°)
â˜ DATABASE_URL (Opsiyonel - direct connection iÃ§in)

GÃ¼venlik Kontrolleri:
--------------------
â˜ Service role key sadece backend'de kullanÄ±lÄ±yor mu?
â˜ RLS tÃ¼m tablolarda aktif mi?
â˜ Admin_users tablosu sadece adminlere aÃ§Ä±k mÄ±?
â˜ Audit_logs Ã§alÄ±ÅŸÄ±yor mu?
â˜ Rate limiting aktif mi? (Supabase Dashboard'da)

================================================================================
8. BÄ°LÄ°NEN SORUNLAR VE Ã‡Ã–ZÃœMLER
================================================================================

Ã‡Ã¶zÃ¼len Sorunlar:
-----------------
âœ… Sonsuz dÃ¶ngÃ¼ sorunu (admin politikalarÄ±) - Ã‡Ã¶zÃ¼ldÃ¼ (2025-01-11)
âœ… RLS politika Ã§akÄ±ÅŸmalarÄ± - DÃ¼zeltildi
âœ… system_performance tablosu eksikliÄŸi - Eklendi (20250930_02)

Dikkat Edilmesi Gerekenler:
---------------------------
âš ï¸ Service role key'i client-side'da KULLANMAYIN
âš ï¸ Migration'lar sÄ±rayla uygulanmalÄ± (tarih bazlÄ±)
âš ï¸ Admin kullanÄ±cÄ± oluÅŸturmadan admin Ã¶zelliklerine eriÅŸemezsiniz
âš ï¸ Credit balance negatif olamaz (fn_create_reading_with_debit kontrolÃ¼ var)

================================================================================
9. PRODUCTION DEPLOYMENT ADIMLARI
================================================================================

1. PRE-DEPLOYMENT
   ----------------
   a. Local veritabanÄ±nÄ± test edin
   b. TÃ¼m migration'larÄ± gÃ¶zden geÃ§irin
   c. Backup alÄ±n (YÃ¶ntem 1 veya 2)
   d. ENV dosyalarÄ±nÄ± production'a gÃ¶re gÃ¼ncelleyin

2. DEPLOYMENT
   -----------
   a. Supabase production projesine baÄŸlanÄ±n
   b. Migration'larÄ± sÄ±rayla uygulayÄ±n:
      ```bash
      # 1. Base tables
      psql < migrations/20241201_01_types.sql
      psql < migrations/20241201_02_tables.sql
      psql < migrations/20241201_03_constraints.sql
      psql < migrations/20241201_04_indexes.sql
      psql < migrations/20241201_05_rls.sql
      psql < migrations/20241201_06_functions.sql
      
      # 2. Updates
      psql < migrations/20250911_01-types.sql
      psql < migrations/20250911_02-tables.sql
      psql < migrations/20250911_03-constraints.sql
      psql < migrations/20250911_04-indexes.sql
      psql < migrations/20250911_05-rls.sql
      
      # 3. Latest changes
      psql < migrations/20250930_01-add-marriage-enum.sql
      psql < migrations/20250930_02-system-performance.sql
      ```
   
   c. RLS politikalarÄ±nÄ± uygulayÄ±n:
      ```bash
      psql < policies.sql
      ```
   
   d. Ä°lk admin kullanÄ±cÄ±yÄ± oluÅŸturun
   e. Test verilerini (gerekirse) ekleyin

3. POST-DEPLOYMENT
   ----------------
   a. TÃ¼m tablolarÄ±n oluÅŸturulduÄŸunu kontrol edin
   b. RLS'in aktif olduÄŸunu doÄŸrulayÄ±n
   c. Test hesabÄ±yla giriÅŸ yapÄ±n
   d. CRUD operasyonlarÄ±nÄ± test edin
   e. Admin paneline eriÅŸimi kontrol edin
   f. Monitoring ayarlarÄ±nÄ± aktifleÅŸtirin

================================================================================
10. ACÄ°L DURUM Ä°LETÄ°ÅÄ°M VE KAYNAKLAR
================================================================================

Supabase Destek:
----------------
â€¢ Dashboard: https://supabase.com/dashboard
â€¢ Docs: https://supabase.com/docs
â€¢ Discord: https://discord.supabase.com
â€¢ Email: support@supabase.io

YararlÄ± SQL SorgularÄ±:
----------------------
-- TÃ¼m tablolarÄ± listele:
SELECT tablename FROM pg_tables WHERE schemaname = 'public';

-- RLS durumunu kontrol et:
SELECT tablename, rowsecurity FROM pg_tables WHERE schemaname = 'public';

-- Database boyutu:
SELECT pg_size_pretty(pg_database_size(current_database()));

-- En bÃ¼yÃ¼k tablolar:
SELECT tablename, pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename))
FROM pg_tables WHERE schemaname = 'public' ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- Aktif baÄŸlantÄ±lar:
SELECT count(*) FROM pg_stat_activity;

-- Son 10 query:
SELECT query, query_start FROM pg_stat_activity ORDER BY query_start DESC LIMIT 10;

================================================================================
11. Ã–ZET VE Ã–NERÄ°LER
================================================================================

Durum: âœ… VERÄ°TABANI PRODUCTION'A HAZIR

Migration Durumu: âœ… TÃœM MIGRATION'LAR MEVCUT
RLS Durumu: âœ… TÃœM POLÄ°TÄ°KALAR TANIMLI
Schema Durumu: âœ… GÃœNCEL VE TUTARLI

YapÄ±lmasÄ± Gerekenler:
---------------------
1. âš ï¸  BACKUP ALIN (Ã–ncelik: YÃœKSEK)
2. âœ…  Production ENV deÄŸiÅŸkenlerini gÃ¼ncelleyin
3. âœ…  Migration'larÄ± production'a uygulayÄ±n
4. âœ…  Ä°lk admin kullanÄ±cÄ±yÄ± oluÅŸturun
5. âœ…  Test senaryolarÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±n
6. âœ…  Monitoring'i aktifleÅŸtirin

Tavsiyeler:
-----------
â€¢ Her migration'dan Ã¶nce backup alÄ±n
â€¢ Migration'larÄ± test ortamÄ±nda Ã¶nce deneyin
â€¢ Service role key'i server-side'da saklayÄ±n
â€¢ Audit logs'u dÃ¼zenli kontrol edin
â€¢ Database metrics'i izleyin (Supabase Dashboard)
â€¢ RLS policy'leri periyodik olarak gÃ¶zden geÃ§irin
â€¢ Performans loglarÄ±nÄ± analiz edin

================================================================================
Rapor Sonu
OluÅŸturulma: 2025-10-13
GeÃ§erlilik: Production deployment Ã¶ncesi
Ä°letiÅŸim: Sistem yÃ¶neticisi
================================================================================

