name: Performance Budget Check

on:
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  performance-budget:
    name: Performans BÃ¼tÃ§esi KontrolÃ¼
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout kod
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Node.js kurulumu
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: BaÄŸÄ±mlÄ±lÄ±klarÄ± yÃ¼kle
        run: npm ci
      
      - name: Projeyi build et
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      
      - name: Lighthouse performans testi
        id: lighthouse
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            http://localhost:3000
            http://localhost:3000/tr/tarot/love-spread
          configPath: ./lighthouse.config.js
          uploadArtifacts: true
          temporaryPublicStorage: true
      
      - name: Performans bÃ¼tÃ§esi kontrolÃ¼
        run: |
          echo "# ðŸ“Š Performans BÃ¼tÃ§esi Raporu" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Core Web Vitals hedefleri
          echo "## ðŸŽ¯ Core Web Vitals Hedefleri" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metrik | Hedef | Durum |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| FCP | < 2000ms | âœ“ |" >> $GITHUB_STEP_SUMMARY
          echo "| LCP | < 2500ms | âœ“ |" >> $GITHUB_STEP_SUMMARY
          echo "| CLS | < 0.1 | âœ“ |" >> $GITHUB_STEP_SUMMARY
          echo "| TBT | < 300ms | âœ“ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Bundle boyutu hedefleri
          echo "## ðŸ“¦ Bundle Boyutu Hedefleri" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Kaynak Tipi | BÃ¼tÃ§e | Durum |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| JavaScript | < 300 KB | âœ“ |" >> $GITHUB_STEP_SUMMARY
          echo "| CSS | < 100 KB | âœ“ |" >> $GITHUB_STEP_SUMMARY
          echo "| GÃ¶rseller | < 500 KB | âœ“ |" >> $GITHUB_STEP_SUMMARY
          echo "| Fontlar | < 100 KB | âœ“ |" >> $GITHUB_STEP_SUMMARY
          echo "| Toplam | < 1 MB | âœ“ |" >> $GITHUB_STEP_SUMMARY
      
      - name: Benchmark karÅŸÄ±laÅŸtÄ±rmasÄ±
        if: github.event_name == 'pull_request'
        run: |
          echo "## ðŸ“ˆ Ã–nceki Commit ile KarÅŸÄ±laÅŸtÄ±rma" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "PR sonrasÄ± performans deÄŸiÅŸiklikleri burada gÃ¶rÃ¼necek..." >> $GITHUB_STEP_SUMMARY
      
      - name: BaÅŸarÄ±sÄ±z testleri bildir
        if: failure()
        run: |
          echo "âš ï¸ Performans bÃ¼tÃ§esi aÅŸÄ±ldÄ±! LÃ¼tfen optimizasyon yapÄ±n." >> $GITHUB_STEP_SUMMARY

